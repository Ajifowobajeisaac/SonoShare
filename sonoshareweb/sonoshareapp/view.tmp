from django.http import JsonResponse
from django.shortcuts import render
from .models import Song
import spotipy
from spotipy.oauth2 import SpotifyOAuth

def test_create_song(request):
    try:
        # Set up Spotify API
        client_id = '31e4302c101d4027ab0da2c6be1763ca'
        client_secret = 'f78a7bde118241c0ae48493ff5bfe4ab'
        redirect_uri = 'http://localhost:3333/callback'
        scope = 'playlist-modify-private playlist-modify-public'


        sp_oauth = SpotifyOAuth(client_id=client_id,
                                client_secret=client_secret,
                                redirect_uri=redirect_uri,
                                scope=scope)
        
        code = request.GET.get('code')
        token_info = sp_oauth.get_access_token(code)
        access_token = token_info['access_token']

        sp = spotipy.Spotify(auth=access_token)

        # Extract the track information from the playlist
        track_name = "Locked In"
        artist_name = "Demi Mulla"

        # Search for the tracks on Spotify
        results = sp.search(q=f'track:{track_name} artist:{artist_name}',
                            type='track', limit=1)
        track = results['tracks']['items'][0]

        # Extract relevant song information
        track_id = track['id']
        track_title = track['name']
        track_artist = track['artists'][0]['name']
        track_album = track['album']['name']
        track_duration = track['duration_ms']

        # Create a new Song object
        song = Song.objects.create(
            title=track_title,
            artist=track_artist,
            service_id=track_id,
            service_name='Spotify',
            duration_ms=track_duration,
            album_name=track_album
        )

        # Create a new playlist
        playlist_name = 'My SonoShare Playlist'
        playlist = sp.user_playlist_create(user=sp.current_user()['id'],
                                         name=playlist_name)

        # Add the song to the playlist
        sp.user_playlist_add_tracks(user=sp.current_user()['id'],
                                playlist_id=playlist['id'], tracks=[track_id])

        playlist_url = playlist['external_urls']['spotify']

        return render(request, 'sonoshareapp/test_create_song.html', {'song': song})

    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)

